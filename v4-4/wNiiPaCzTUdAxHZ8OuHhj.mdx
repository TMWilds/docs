---
title: Upserting and Updating
description: "This article provides an overview of the Upsert and Update operations"
---
- [Key Distinctions]()
- [Update]()
- [Upsert]()

# Key Distinctions&#x20;

# Upsert

Use the Upsert method to achieve any of the following:

- Making changes only to targeted fields
- Creating a new document
- Configuring a custom document ID

<Info>
For instructions on how to create a new document, see [Upserting and Updating]().
</Info>

The following snippet provides the standard upsert syntax, consisting of the `document` object that you want to upsert and the `options` you want to set for the upsert:


<Tabs>
  <Tab title="Swift">
    ```swift
    let documentId = ditto.store
      .collection("your_collection_name")
      .upsert(document, options: options)
    ```
  </Tab>

  <Tab title="Kotlin">
    ```kotlin
    val documentId = ditto.store
        .collection("your_collection_name")
        .upsert([document], [options])
    ```
  </Tab>

  <Tab title="JavaScript">
    ```javascript
    const documentId = await ditto.store
      .collection("your_collection_name")
      .upsert([document], [options])
    ```
  </Tab>

  <Tab title="Java">
    ```java
    DittoDocumentId documentId = ditto.store
      .collection("your_collection_name")
      .upsert([document], [options])
    ```
  </Tab>

  <Tab title="C#">
    ```csharp
    var documentId = ditto.Store
      .Collection("your_collection_name")
      .Upsert([document], [options]);
    ```
  </Tab>

  <Tab title="C++">
    ```cpp
    DocumentId documentId = ditto.get_store()
      .collection("your_collection_name")
      .upsert([document], [options])
    ```
  </Tab>

  <Tab title="Rust">
    ```rust
    //basic upsert:

    let collection = ditto.store()
      .collection("your_collection_name").unwrap();

    let documentId = collection.upsert([document])


    //custom upsert based on options:

    let documentId = collection.upsert_with_strategy(([document], options)
    ```
  </Tab>
</Tabs>


## Creating New Documents

When writing updates by way of the Upsert function:

- If the document already exists, Ditto updates the document with the delta changes.
- If the document does *not* exist, Ditto automatically creates one. &#x20;

<Info>
If not manually supplied, Ditto automatically assigns the new document a unique ID as follows:&#x20;
</Info>


<Tabs>
  <Tab title="Swift">
    ```swift
    let docId = ditto.store.collection("your_collection_name").upsert(document)
    ```
  </Tab>

  <Tab title="Kotlin">
    ```kotlin
    let docId = ditto.store.collection("your_collection_name").upsert(document)

    // documentId = "507f191e810c19729de860ea"
    ```
  </Tab>

  <Tab title="JavaScript">
    ```javascript
    const documentId = await ditto.store
      .collection("cars").upsert({color: "blue"})

    console.log(documentId) // "507f191e810c19729de860ea"
    ```
  </Tab>

  <Tab title="Java">
    ```java
    Map<String, Object> content = new HashMap<>();
    content.put("name", "Susan");
    content.put("age", 31);
    DittoDocumentId docId = ditto.store.collection("people").upsert(content);
    // docId => 507f191e810c19729de860ea
    ```
  </Tab>

  <Tab title="C#">
    ```csharp
    var document = new Dictionary<string, object> {{ "color", "blue" }};
    var documentId = ditto.Store.Collection("cars").Upsert(document);

    Console.WriteLine(documentId); // "507f191e810c19729de860ea"
    ```
  </Tab>

  <Tab title="C++">
    ```cpp
    json document = json({{"color", "blue"}});
    DocumentId documentId = ditto.get_store()
      .collection("cars")
      .upsert(document)

    // documentId = "507f191e810c19729de860ea"
    ```
  </Tab>

  <Tab title="Rust">
    ```rust
    let document = json!({
      "color": "blue".to_string(),
    });
    let documentId = collection.upsert(document);

    // documentId = "507f191e810c19729de860ea"
    ```
  </Tab>
</Tabs>



## Supplying a Custom ID

For more information about document IDs, see *Platform Manual *> [Document Model](<./../Document Model.md>).

### String ID

For example, the following snippet demonstrates a new document assigned the custom ID `abc123`.

<Tabs>
  <Tab title="Swift">
    ```swift
    do {
        // upsert JSON-compatible data into Ditto
        let docID = try ditto.store["people"].upsert([
            "_id": "abc123",
            "name": "Susan",
            "age": 31
        ])
        print(docID) // "abc123"
    } catch {
        //handle error
        print(error)
    }
    ```
  </Tab>

  <Tab title="Kotlin">
    ```kotlin
    val docId = ditto.store["people"].upsert(
        mapOf(
            "_id" to "abc123",
            "name" to "Susan",
            "age" to 31
        )
    )
    ```
  </Tab>

  <Tab title="JavaScript">
    ```javascript
    const document = {
      _id: "abc123",
      name: "Susan",
      age: 31
    }
    const documentId = await ditto.store.collection("cars").upsert(document)

    console.log(documentId) // "abc123"
    ```
  </Tab>

  <Tab title="Java">
    ```java
    Map<String, Object> content = new HashMap<>();
    content.put("_id", "abc123");
    content.put("name", "Susan");
    content.put("age", 31);

    DittoDocumentId docId = ditto.store.collection("people").upsert(content);
    // docId => abc123
    ```
  </Tab>

  <Tab title="C#">
    ```csharp
    var document = new Dictionary<string, object> {
      { "_id", "123456" },
      { "color", "blue" },
    };
    var documentId = ditto.Store.Collection("cars").Upsert(document);

    Console.WriteLine(documentId); // "123456"
    ```
  </Tab>

  <Tab title="C++">
    ```cpp
    json document = json({{"_id", "123456"}, {"color", "blue"}});
    DocumentId documentId = ditto.get_store()
      .collection("cars")
      .upsert(document)

    // documentId = "123456"
    ```
  </Tab>

  <Tab title="Rust">
    ```rust
    let doc_id = DocumentId::new(&"123456".to_string()).unwrap();
    let document = json!({
      "_id": doc_id,
      "color": "blue".to_string(),
    });
    let documentId = collection.upsert(document)

    // documentId = "123456"
    ```
  </Tab>
</Tabs>


Following is the new `abc123` document that results:

```json
{
  "_id": "abc123",
  "name": "Susan",
  "age": 31,
}
```

### Composite ID

The following snippet demonstrates combining the `user_id` and `work_id` fields to form the `456abc789` composite key:

hint{type="info"}
To mitigate the risk of human error when working with composite keys during write operations, it is recommended to use no more than three fields to form your key.


<Tabs>
  <Tab title="Swift">
    ```swift
    do {
        let docID = try ditto.store["people"].upsert([
            "_id": [ "userId": "456abc", "workId": 789 ] as [String : Any],
            "name": "Susan",
            "age": 31
        ])
        print(docID) // "[ "userId": "456abc", "workId": 789 ]"
    } catch {
        //handle error
        print(error)
    }
    ```
  </Tab>

  <Tab title="Kotlin">
    ```kotlin
    val docId = ditto.store["people"].upsert(
        mapOf(
            "_id" to mapOf( "userId" to "456abc", "workId" to 789),
            "name" to "Susan",
            "age" to 31
        )
    )
    ```
  </Tab>

  <Tab title="JavaScript">
    ```javascript
    const docID = await ditto.store.collection('cars').upsert({
     _id: {
        user_id: "123abc",
        work_id: 789
      }
    })

    console.log(docID) // "123abc789"
    ```
  </Tab>

  <Tab title="Java">
    ```java
    Map<String, Object> _id = new HashMap<>();
    _id.put("userId", "456abc");
    _id.put("workId", 789);

    Map<String, Object> value = new HashMap<>();
    value.put("_id", _id);
    value.put("name", "Susan");
    value.put("age", 31);
    DittoDocumentId docID = ditto.store.collection("people").upsert(value);
    // docId=> "_id.put("userId", "456abc"); _id.put("workId", 789);"
    ```
  </Tab>

  <Tab title="C#">
    ```csharp
    var document = new Map<string, object> {
      {
        { "_id", new Map<string, string> { { "user_id", "123" },
        { "work_id", "abc" } } }
    };
    var documentId = ditto.Store.Collection("cars").Upsert(document);

    Console.WriteLine(documentId); // "123abc"
    ```
  </Tab>

  <Tab title="C++">
    ```cpp
    json content = {
            { "_id", {
                { "userId", "456abc" },
                { "workId", 789 }
            }},
            { "name", "Susan" },
            { "age", 31 }
        };

    DocumentId doc_ID = ditto.get_store().collection("people").upsert(content.dump());
    ```
  </Tab>

  <Tab title="Rust">
    ```rust
    let document_id = ditto.store.collection("cars").upsert(
        maplit::hashmap! {
            "_id" => hashmap! { "userId" => "456abc", "workId" => 789 },
            "name" => "Susan",
            "age" => 31,
        },
    );

    // document_id = "456abc789"
    ```
  </Tab>
</Tabs>



## Upserting Delta Updates

<Warning>
Using the `upsert` method to update data can cause performance to degrade. To optimize performance and reduce unnecessary overhead, apply most updates in your app through the `update` method instead. For more information, see [Optimizations]().&#x20;
</Warning>

For example, imagine you create the following document in the `cars` collection: &#x20;


<Tabs>
  <Tab title="Swift">
    ```swift
    let docID = try ditto.store["cars"].upsert([
        "_id": "123456",
        "make": "Toyota",
        "color": "blue",
        "year": 2024
    ])
    ```
  </Tab>

  <Tab title="Kotlin">
    ```kotlin
    val docID = ditto.store["cars"].upsert(mapOf(
        "_id" to "123456",
        "make" to "Toyota",
        "color" to "blue",
        "year" to 2024
    ))
    ```
  </Tab>

  <Tab title="JavaScript">
    ```javascript
    const docID = await ditto.store.collection("cars").upsert({
        _id: "123456",
        make: "Toyota",
        color: "blue",
        year: 2023
    })
    ```
  </Tab>

  <Tab title="Java">
    ```java
    Map<String, Object> content = new HashMap<>();
    content.put("_id", "123456");
    content.put("make", "Toyota");
    content.put("color", "blue");
    content.put("year", 2024);
    DittoDocumentId docId = ditto.store.collection("cars").upsert(content);
    ```
  </Tab>

  <Tab title="C#">
    ```csharp
    var docId = ditto.Store.Collection("cars").Upsert(
        new Dictionary<string, object>
        {
            { "_id", "123456" },
            { "model", "Toyota" },
            { "color", "blue" },
            { "year", 2024 }
        }
    );
    ```
  </Tab>

  <Tab title="C++">
    ```cpp
    json car = {
        {"_id", "123456"},
        {"make", "Toyota"},
        {"_id", "123456"},
        {"_id", "123456"},
    };
    ditto.get_store().collection("cars").upsert(car);
    ```
  </Tab>

  <Tab title="Rust">
    ```rust
    let doc_id = DocumentId::new(&"123456".to_string()).unwrap();
    let car = json!({ // car implements serde::Serialize
        "_id": doc_id,
        "make": "Toyota".to_string(),
        "color": "blue".to_string(),
        "year": 2024,
    });
    collection.upsert(car).unwrap();
    ```
  </Tab>
</Tabs>


Once executed, the following document is created as a result:

```json
{
  "_id": "123456",
  "model": "Toyota",
  "color": "blue",
  "year": 2024
}
```

When you upsert changes, only the fields you supplied will be modified; existing fields remain unchanged. For instance, consider the following Upsert in which you change the color `"blue"` to `"red"`:


<Tabs>
  <Tab title="Swift">
    ```swift
    do {
        // find the document by ID
        let document = try ditto.store["cars"].findByID("123456")

        // change the color to "red"
        try document?.update({ mutableDoc in
            mutableDoc?["color"] = "red"
        })
    } catch {
        // handle error
        print(error)
    }
    ```
  </Tab>

  <Tab title="Kotlin">
    ```kotlin
    try {
        // find the document by ID
        val document = ditto.store["cars"].findByID("123456")

        // change the color to "red"
        document?.update { mutableDoc ->
            mutableDoc?.set("color", "red")
        }
    } catch (e: Exception) {
        // handle error
        println(e)
    }
    ```
  </Tab>

  <Tab title="JavaScript">
    ```javascript
    try {
        // find the document by ID
        const document = await ditto.store.collection("cars").findByID("123456");
        // change the color to "red"
        await document.update(mutableDoc => {
            mutableDoc.set("color", "red");
        });
    } catch (error) {
        // handle error
        console.error(error);
    }
    ```
  </Tab>

  <Tab title="Java">
    ```java
    try {
        // find the document by ID
        DittoDocument document = ditto.store.collection("cars").findByID("123456");

        if (document != null) {
            // change the color to "red"
            document.update(mutableDoc -> {
                mutableDoc.set("color", "red");
            });
        }
    } catch (Exception e) {
        // handle error
        e.printStackTrace();
    }
    ```
  </Tab>

  <Tab title="C#">
    ```csharp
        // find the document by ID
        var document = ditto.Store.Collection("cars").FindByID("123456");

        // change the color to "red"
        document.Update(mutableDoc =>
        {
            mutableDoc.Set("color", "red");
        });
    }
    // handle error
    catch (Exception e)
    {
    ```
  </Tab>

  <Tab title="C++">
    ```cpp
    // find the document by ID and upsert color to "red"
    json updatedDocument = {
        {"_id", "123456"},
        {"color", "red"}
    };
    ditto.get_store().collection("cars").update(car);
    ```
  </Tab>

  <Tab title="Rust">
    ```rust
    // find the document by ID
    match ditto.store.collection("cars").find_by_id("123456") {
        Ok(mut document) => {
          // change the color to "red"
            document.update(|mutable_doc| {
                mutable_doc.set("color", "red");
            });
        },
        Err(e) => {
            // Handle error
            println!("{:?}", e);
        }
    }
    ```
  </Tab>
</Tabs>



As a result, the color changes to `"red"`; however, make and year remain the same:

```json
{
  "_id": "123456",
  "model": "Toyota",
  "color": "red",
  "year": 2024
}
```

# Update




<Tabs>
  <Tab title="Swift">
    ```swift
    ditto.store["your_collection_name"]
      .findByID("document_ID")
      .update([your update function])
    ```
  </Tab>

  <Tab title="Kotlin">
    ```kotlin
    ditto.store
      .collection("your_collection_name")
      .findByID("document_id")
      .update([your update_function])
    ```
  </Tab>

  <Tab title="JavaScript">
    ```javascript
    await ditto.store
      .collection("your_collection_name")
      .findByID("document_id")
      .update([update_function])
    ```
  </Tab>

  <Tab title="Java">
    ```java
    ditto.store.collection("people").findById(docId).update(doc -> {
        try {
            doc.get("age").set(32);
            doc.get("ownedCars").getCounter().increment(1);
        } catch (DittoError err) {
            // Do something with error
        }
    });
    ```
  </Tab>

  <Tab title="C#">
    ```csharp
    ditto.Store
      .Collection("your_collection_name")
      .FindByID("document_id")
      .Update([update_function])
    ```
  </Tab>

  <Tab title="C++">
    ```cpp
    ditto.get_store()
      .collection("your_collection_name")
      .find_by_id("document_id")
      .update([update_function])
    ```
  </Tab>

  <Tab title="Rust">
    ```rust
    let collection = ditto.store["your_collection_name"];
    let document = collection.findByID("document_ID");

    if let Some(document) = document {
        let updatedDocument = your_update_function(&document);
        collection.update(updatedDocument);
    }
    ```
  </Tab>
</Tabs>



## Overview of Behavior by CRDT&#x20;

Updating an existing document is different depending on the CRDT you're updating:



